<script>
    let currentTab = 'video';
    
    function switchTab(tab) {
        currentTab = tab;
        
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        document.getElementById('videoTab').classList.toggle('active', tab === 'video');
        document.getElementById('photoTab').classList.toggle('active', tab === 'photo');
        
        hideError();
    }
    
    function setExampleVideo(e) {
        e.preventDefault();
        document.getElementById('videoUrlInput').value = 'https://vt.tiktok.com/ZSm5vrd7E/';
    }
    
    function setExamplePhoto(e) {
        e.preventDefault();
        document.getElementById('photoUrlInput').value = 'https://vt.tiktok.com/ZSm5vrd7E/';
    }
    
    async function downloadVideo() {
        const url = document.getElementById('videoUrlInput').value.trim();
        
        if (!url) {
            showError('Вставь ссылку на видео TikTok');
            return;
        }
        
        if (!url.includes('tiktok.com')) {
            showError('Это не похоже на ссылку TikTok');
            return;
        }
        
        await processVideoRequest(url);
    }
    
    async function analyzePhotos() {
        const url = document.getElementById('photoUrlInput').value.trim();
        
        if (!url) {
            showError('Вставь ссылку на фото TikTok');
            return;
        }
        
        if (!url.includes('tiktok.com')) {
            showError('Это не похоже на ссылку TikTok');
            return;
        }
        
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const downloadBtn = document.getElementById('photoDownloadBtn');
        
        loading.classList.add('active');
        downloadBtn.disabled = true;
        hideError();
        
        loadingText.textContent = 'Анализируем фото...';
        
        try {
            const formData = new FormData();
            formData.append('url', url);
            
            const response = await fetch('/analyze/photos', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.error) {
                showError(data.error);
                return;
            }
            
            sessionStorage.setItem('tiktokPhotos', JSON.stringify(data));
            window.location.href = '/photos';
            
        } catch (err) {
            showError('Ошибка при анализе ссылки');
            console.error(err);
        } finally {
            loading.classList.remove('active');
            downloadBtn.disabled = false;
        }
    }
    
    async function processVideoRequest(url) {
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const downloadBtn = document.getElementById('videoDownloadBtn');
        
        loading.classList.add('active');
        downloadBtn.disabled = true;
        hideError();
        
        loadingText.textContent = 'Скачиваем видео...';
        
        try {
            const formData = new FormData();
            formData.append('url', url);
            
            const response = await fetch('/download/video', {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = 'tiktok_video.mp4';
                a.click();
                window.URL.revokeObjectURL(downloadUrl);
                
                showInfo('✅ Видео успешно скачано!');
            } else {
                const data = await response.json();
                showError(data.error || 'Ошибка скачивания');
            }
            
        } catch (err) {
            showError('Ошибка при скачивании');
            console.error(err);
        } finally {
            loading.classList.remove('active');
            downloadBtn.disabled = false;
        }
    }
    
    function showError(message) {
        const error = document.getElementById('error');
        error.textContent = '❌ ' + message;
        error.classList.add('active');
        
        setTimeout(() => {
            error.classList.remove('active');
        }, 5000);
    }
    
    function showInfo(message) {
        const info = document.getElementById('infoMessage');
        info.textContent = message;
        info.classList.add('active');
        
        setTimeout(() => {
            info.classList.remove('active');
        }, 3000);
    }
    
    function hideError() {
        document.getElementById('error').classList.remove('active');
        document.getElementById('infoMessage').classList.remove('active');
    }
    
    // Enter для отправки
    document.getElementById('videoUrlInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            downloadVideo();
        }
    });
    
    document.getElementById('photoUrlInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            analyzePhotos();
        }
    });
</script>
