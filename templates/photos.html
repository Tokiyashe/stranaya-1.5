<script>
    const photosData = JSON.parse(sessionStorage.getItem('tiktokPhotos'));
    
    if (!photosData || !photosData.images || photosData.images.length === 0) {
        alert('Нет данных о фото. Вернитесь на главную.');
        window.location.href = '/';
    }
    
    document.getElementById('photoInfo').innerHTML = `
        <strong>Автор:</strong> ${photosData.author || 'Unknown'}<br>
        <strong>Всего фото:</strong> ${photosData.count || photosData.images.length}
    `;
    
    const photoGrid = document.getElementById('photoGrid');
    const downloadBtn = document.getElementById('downloadBtn');
    const counter = document.getElementById('counter');
    const selectedIndices = new Set();
    const filesList = document.getElementById('filesList');
    const filesContainer = document.getElementById('filesContainer');
    
    // Отображаем все фото
    photosData.images.forEach((imgUrl, index) => {
        const card = document.createElement('div');
        card.className = 'photo-card';
        card.innerHTML = `
            <img src="${imgUrl}" alt="Photo ${index + 1}" loading="lazy">
            <div class="photo-checkbox" id="check-${index}">✓</div>
        `;
        
        card.addEventListener('click', (e) => {
            e.preventDefault();
            toggleSelect(index);
        });
        
        photoGrid.appendChild(card);
    });
    
    function toggleSelect(index) {
        if (selectedIndices.has(index)) {
            selectedIndices.delete(index);
        } else {
            selectedIndices.add(index);
        }
        updateSelection();
    }
    
    function updateSelection() {
        document.querySelectorAll('.photo-card').forEach((card, idx) => {
            if (selectedIndices.has(idx)) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        });
        
        const count = selectedIndices.size;
        downloadBtn.textContent = `Скачать выбранные (${count})`;
        downloadBtn.disabled = count === 0;
        counter.textContent = `Выбрано: ${count} из ${photosData.images.length}`;
    }
    
    // Выбрать все
    document.getElementById('selectAll').addEventListener('change', (e) => {
        if (e.target.checked) {
            photosData.images.forEach((_, idx) => selectedIndices.add(idx));
        } else {
            selectedIndices.clear();
        }
        updateSelection();
    });
    
    // Получение выбранного метода скачивания
    function getDownloadType() {
        const radio = document.querySelector('input[name="downloadType"]:checked');
        return radio ? radio.value : 'single';
    }
    
    // Скачивание
    downloadBtn.addEventListener('click', async () => {
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const downloadType = getDownloadType();
        
        loading.classList.add('active');
        downloadBtn.disabled = true;
        if (filesList) filesList.classList.remove('active');
        
        loadingText.textContent = downloadType === 'zip' ? 'Создаём архив...' : 'Подготавливаем фото...';
        
        try {
            const selectedUrls = Array.from(selectedIndices).map(idx => photosData.images[idx]);
            
            const formData = new FormData();
            selectedUrls.forEach(url => {
                formData.append('image_urls', url);
            });
            formData.append('download_type', downloadType);
            
            const response = await fetch('/download/photos', {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                if (downloadType === 'zip') {
                    // Скачиваем ZIP
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = 'tiktok_photos.zip';
                    a.click();
                    window.URL.revokeObjectURL(downloadUrl);
                    alert('✅ Архив успешно скачан!');
                } else {
                    // Получаем список файлов
                    const data = await response.json();
                    
                    if (data.type === 'multiple') {
                        // Показываем список файлов
                        if (filesContainer) {
                            filesContainer.innerHTML = '';
                            data.files.forEach(file => {
                                const fileDiv = document.createElement('div');
                                fileDiv.className = 'file-item';
                                fileDiv.innerHTML = `
                                    <span>${file.filename}</span>
                                    <a href="${file.url}" download>Скачать</a>
                                `;
                                filesContainer.appendChild(fileDiv);
                            });
                        }
                        if (filesList) filesList.classList.add('active');
                    } else {
                        // Одно фото - скачиваем напрямую
                        const blob = await response.blob();
                        const downloadUrl = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = downloadUrl;
                        a.download = 'tiktok_photo.jpg';
                        a.click();
                        window.URL.revokeObjectURL(downloadUrl);
                    }
                }
            } else {
                const data = await response.json();
                alert('❌ Ошибка: ' + (data.error || 'Не удалось скачать фото'));
            }
            
        } catch (err) {
            alert('❌ Ошибка при скачивании');
            console.error(err);
        } finally {
            loading.classList.remove('active');
            downloadBtn.disabled = false;
        }
    });
    
    function hideFilesList() {
        if (filesList) filesList.classList.remove('active');
    }
    
    // Добавляем обработчик для радиокнопок если они есть
    const radioButtons = document.querySelectorAll('input[name="downloadType"]');
    if (radioButtons.length) {
        radioButtons.forEach(radio => {
            radio.addEventListener('change', () => {
                if (filesList) filesList.classList.remove('active');
            });
        });
    }
</script>
